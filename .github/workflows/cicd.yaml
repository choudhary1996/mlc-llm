name: Production CI/CD - MLC LLM

on:
  push:
    branches: [ main ]
  pull_request:

env:
  PYTHON_VERSION: "3.13"

jobs:

  test-linux:
    runs-on: ubuntu-22.04

    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - uses: conda-incubator/setup-miniconda@v3
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          activate-environment: mlc-chat-venv
          channels: conda-forge

      # ---------------- DEPS ----------------
      - name: Install build deps
        shell: bash -l {0}
        run: |
          conda install -y cmake>=3.24 rust git
          pip install wheel setuptools build pytest

      # ---------------- BUILD ----------------
      - name: Build Runtime
        shell: bash -l {0}
        run: |
          mkdir build && cd build

          printf "\n\nn\nn\nn\nn\nn\nn\n" | \
          python ../cmake/gen_cmake_config.py

          cmake ..
          make -j$(nproc)

          # Place libs where TVM expects
          mkdir -p ../3rdparty/tvm/build
          cp libtvm*.so ../3rdparty/tvm/build/ || true
          cp libtvm_runtime*.so ../3rdparty/tvm/build/ || true

      # ---------------- TVM ----------------
      - name: Install TVM Python
        shell: bash -l {0}
        run: |
          cd 3rdparty/tvm/python
          pip install -e .

      # ---------------- MLC (NO DEPS) ----------------
      - name: Install MLC-LLM (no external TVM)
        shell: bash -l {0}
        run: |
          cd python
          pip install -e . --no-deps

          # Install safe deps only
          pip install \
            datasets fastapi openai pandas \
            prompt_toolkit requests safetensors \
            sent
